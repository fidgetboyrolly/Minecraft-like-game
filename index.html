<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Fidget Script Game</title>
    <style>
        body { font-family: Arial, sans-serif; }
        #fileInputContainer { margin: 20px; }
        #canvas { display: none; border: 1px solid #ddd; margin-top: 20px; width: 800px; height: 600px; }
        #output { display: none; border: 1px solid #ddd; padding: 10px; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="fileInputContainer">
        <h1>Upload Your Fidget Script</h1>
        <input type="file" id="fileInput" accept=".fidscy">
    </div>
    <canvas id="canvas" width="800" height="600"></canvas>
    <div id="output"></div>

    <script>
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    processFidgetScript(content);
                };
                reader.readAsText(file);
            }
        });

        function processFidgetScript(content) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(content, 'application/xml');

            const display = xmlDoc.querySelector('display');
            const ren = display.querySelector('ren').getAttribute('value');
            const fileInputContainer = document.getElementById('fileInputContainer');
            fileInputContainer.style.display = 'none';

            if (ren === '3D') {
                document.getElementById('canvas').style.display = 'block';
                init3DGame(xmlDoc);
            } else {
                document.getElementById('canvas').style.display = 'block';
                init2DGame(xmlDoc);
            }
        }

        function init3DGame(xmlDoc) {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 3D Rendering with simple perspective projection
            const fov = 500;
            const cameraZ = 300;

            function drawCube(x, y, z, size, color) {
                const points = [
                    { x: x - size / 2, y: y - size / 2, z: z - size / 2 },
                    { x: x + size / 2, y: y - size / 2, z: z - size / 2 },
                    { x: x + size / 2, y: y + size / 2, z: z - size / 2 },
                    { x: x - size / 2, y: y + size / 2, z: z - size / 2 },
                    { x: x - size / 2, y: y - size / 2, z: z + size / 2 },
                    { x: x + size / 2, y: y - size / 2, z: z + size / 2 },
                    { x: x + size / 2, y: y + size / 2, z: z + size / 2 },
                    { x: x - size / 2, y: y + size / 2, z: z + size / 2 },
                ];

                const projected = points.map(p => {
                    const scale = fov / (fov + p.z + cameraZ);
                    return { x: p.x * scale + canvas.width / 2, y: p.y * scale + canvas.height / 2 };
                });

                ctx.strokeStyle = color;
                ctx.beginPath();
                // Draw front face
                ctx.moveTo(projected[0].x, projected[0].y);
                projected.slice(1, 4).forEach(p => ctx.lineTo(p.x, p.y));
                ctx.closePath();
                ctx.stroke();

                // Draw back face
                ctx.beginPath();
                ctx.moveTo(projected[4].x, projected[4].y);
                projected.slice(5, 8).forEach(p => ctx.lineTo(p.x, p.y));
                ctx.closePath();
                ctx.stroke();

                // Draw connecting lines
                for (let i = 0; i < 4; i++) {
                    ctx.beginPath();
                    ctx.moveTo(projected[i].x, projected[i].y);
                    ctx.lineTo(projected[i + 4].x, projected[i + 4].y);
                    ctx.closePath();
                    ctx.stroke();
                }
            }

            const playerSprite = xmlDoc.querySelector('sprite[player="true"]');
            drawCube(0, 0, 0, 50, 'green');

            const groundObject = xmlDoc.querySelector('object');
            drawCube(0, 100, 0, 400, 'gray');
        }

        function init2DGame(xmlDoc) {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            const playerSprite = xmlDoc.querySelector('sprite[player="true"]');
            const player = {
                x: 400,
                y: 300,
                size: 50,
                color: 'green',
                startpos: playerSprite.getAttribute('startpos')
            };

            function drawPlayer() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = player.color;
                ctx.fillRect(player.x, player.y, player.size, player.size);
            }

            drawPlayer();
        }
    </script>
</body>
</html>
